-- Step 1: Context setup
USE ROLE ACCOUNTADMIN;
USE WAREHOUSE COMPUTE_WH;

-- Step 2: Create database & schema
CREATE OR REPLACE DATABASE CRYPTO_DB;
CREATE OR REPLACE SCHEMA CRYPTO_DB.ANALYSIS;
USE SCHEMA CRYPTO_DB.ANALYSIS;

-- Step 3: Create an empty table matching your CSV
CREATE OR REPLACE TABLE ALL_COINS (
    ID STRING,
    SYMBOL STRING,
    NAME STRING,
    CURRENT_PRICE FLOAT,
    MARKET_CAP FLOAT,
    MARKET_CAP_RANK FLOAT,
    FULLY_DILUTED_VALUATION FLOAT,
    TOTAL_VOLUME FLOAT,
    HIGH_24H FLOAT,
    LOW_24H FLOAT,
    PRICE_CHANGE_24H FLOAT,
    PRICE_CHANGE_PERCENTAGE_24H FLOAT,
    MARKET_CAP_CHANGE_24H FLOAT,
    MARKET_CAP_CHANGE_PERCENTAGE_24H FLOAT,
    CIRCULATING_SUPPLY FLOAT,
    TOTAL_SUPPLY FLOAT,
    MAX_SUPPLY FLOAT,
    ATH FLOAT,
    ATH_CHANGE_PERCENTAGE FLOAT,
    ATH_DATE TIMESTAMP,
    ATL FLOAT,
    ATL_CHANGE_PERCENTAGE FLOAT,
    ATL_DATE TIMESTAMP,
    LAST_UPDATED TIMESTAMP,
    LIQUIDITY_RATIO FLOAT,
    IS_STABLECOIN BOOLEAN
);

-- A. Descriptive Market Overview

-- Top 10 coins by market cap (market leaders)
SELECT NAME, SYMBOL, MARKET_CAP
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
ORDER BY MARKET_CAP DESC
LIMIT 10;

-- Summary of crypto prices
SELECT 
  MIN(CURRENT_PRICE) AS min_price,
  MAX(CURRENT_PRICE) AS max_price,
  AVG(CURRENT_PRICE) AS avg_price,
  MEDIAN(CURRENT_PRICE) AS median_price
FROM CRYPTO_DB.ANALYSIS.ALL_COINS;

-- Find stablecoins (price close to 1 USD)
SELECT NAME, SYMBOL, CURRENT_PRICE
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
WHERE CURRENT_PRICE BETWEEN 0.98 AND 1.02;


-- B. Comparative & Volatility Insights

-- ATH (All-Time High) vs. Current Price
-- Coins that have dropped most from ATH
SELECT NAME, SYMBOL, CURRENT_PRICE, ATH, 
       ROUND(((ATH - CURRENT_PRICE) / ATH) * 100, 2) AS percent_drop_from_ath
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
WHERE ATH > 0
ORDER BY percent_drop_from_ath DESC
LIMIT 10;

-- Top 10 most volatile coins (excluding NULL values)
SELECT 
  NAME, 
  SYMBOL, 
  PRICE_CHANGE_PERCENTAGE_24H
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
WHERE PRICE_CHANGE_PERCENTAGE_24H IS NOT NULL
ORDER BY ABS(PRICE_CHANGE_PERCENTAGE_24H) DESC
LIMIT 10;

--  List all coins where 24h price change % is missing
SELECT 
  NAME, 
  SYMBOL
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
WHERE PRICE_CHANGE_PERCENTAGE_24H IS NULL
ORDER BY NAME;

-- Spot outliers based on extreme price change
SELECT NAME, SYMBOL, PRICE_CHANGE_PERCENTAGE_24H
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
WHERE ABS(PRICE_CHANGE_PERCENTAGE_24H) > 100;

-- Top 10 coins with highest 24h volatility
SELECT 
  NAME, 
  SYMBOL, 
  ROUND(ABS(PRICE_CHANGE_PERCENTAGE_24H), 2) AS volatility_score
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
WHERE PRICE_CHANGE_PERCENTAGE_24H IS NOT NULL
ORDER BY volatility_score DESC
LIMIT 10;

-- C. Liquidity & Activity Analysis
-- Find coins with high liquidity (high trading activity)
SELECT NAME, SYMBOL, TOTAL_VOLUME, MARKET_CAP,
       ROUND(TOTAL_VOLUME / MARKET_CAP, 4) AS liquidity_ratio
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
WHERE MARKET_CAP > 0
ORDER BY liquidity_ratio DESC
LIMIT 15;

DESC TABLE CRYPTO_DB.ANALYSIS.ALL_COINS;

-- Recommend coins with recent strong 24h growth, good liquidity, and lower market cap rank
SELECT 
    NAME, 
    SYMBOL, 
    MARKET_CAP_RANK, 
    PRICE_CHANGE_PERCENTAGE_24H, 
    TOTAL_VOLUME
FROM 
    CRYPTO_DB.ANALYSIS.ALL_COINS
WHERE 
    MARKET_CAP_RANK > 100  -- Avoiding top 100 coins
    AND PRICE_CHANGE_PERCENTAGE_24H > 10  -- Significant recent growth
    AND TOTAL_VOLUME > 5000000  -- Reasonable liquidity
ORDER BY 
    PRICE_CHANGE_PERCENTAGE_24H DESC
LIMIT 10;

-- Top 100 coins with strong growth
SELECT NAME, SYMBOL, PRICE_CHANGE_PERCENTAGE_24H, TOTAL_VOLUME
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
WHERE MARKET_CAP_RANK <= 100
  AND PRICE_CHANGE_PERCENTAGE_24H > 5
ORDER BY PRICE_CHANGE_PERCENTAGE_24H DESC
LIMIT 10;

-- Segment market cap size
SELECT 
  NAME,
  CASE 
    WHEN MARKET_CAP > 1e10 THEN 'Mega Cap'
    WHEN MARKET_CAP > 1e9 THEN 'Large Cap'
    WHEN MARKET_CAP > 1e8 THEN 'Mid Cap'
    ELSE 'Small Cap'
  END AS cap_segment
FROM CRYPTO_DB.ANALYSIS.ALL_COINS;

-- Coins with 60â€“80% drawdown from ATH (possible recovery potential)
SELECT NAME, SYMBOL, CURRENT_PRICE, ATH,
       ROUND(((ATH - CURRENT_PRICE) / ATH) * 100, 2) AS drop_from_ath
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
WHERE ATH > 0
  AND ((ATH - CURRENT_PRICE) / ATH) BETWEEN 0.6 AND 0.8
ORDER BY drop_from_ath DESC;

-- Top 10 Gainers
SELECT NAME, SYMBOL, PRICE_CHANGE_PERCENTAGE_24H
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
ORDER BY PRICE_CHANGE_PERCENTAGE_24H DESC
LIMIT 10;

-- Top 10 Losers
SELECT NAME, SYMBOL, PRICE_CHANGE_PERCENTAGE_24H
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
ORDER BY PRICE_CHANGE_PERCENTAGE_24H ASC
LIMIT 10;

-- Boolean Flag Segments
-- Most traded stablecoins
SELECT NAME, SYMBOL, TOTAL_VOLUME
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
WHERE IS_STABLECOIN = TRUE
ORDER BY TOTAL_VOLUME DESC
LIMIT 10;

-- Show market cap segments with average price, average volume, and coin names
SELECT 
  CASE 
    WHEN MARKET_CAP > 1e10 THEN 'Mega Cap'
    WHEN MARKET_CAP > 1e9 THEN 'Large Cap'
    WHEN MARKET_CAP > 1e8 THEN 'Mid Cap'
    ELSE 'Small Cap'
  END AS cap_segment,
  
  ROUND(AVG(CURRENT_PRICE), 2) AS avg_price,
  ROUND(AVG(TOTAL_VOLUME), 2) AS avg_volume,
  ARRAY_AGG(NAME) AS coin_names  -- Collect all coin names in this segment
  
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
GROUP BY cap_segment;

-- Create Advanced Analysis Views

-- View 1: TOP_MARKET_CAP_COINS
CREATE OR REPLACE VIEW CRYPTO_DB.ANALYSIS.TOP_MARKET_CAP_COINS AS
SELECT NAME, SYMBOL, MARKET_CAP
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
ORDER BY MARKET_CAP DESC
LIMIT 10;

-- Checking the result
SELECT * FROM CRYPTO_DB.ANALYSIS.TOP_MARKET_CAP_COINS LIMIT 5;

-- View 2: STABLECOINS
CREATE OR REPLACE VIEW CRYPTO_DB.ANALYSIS.STABLECOINS AS
SELECT NAME, SYMBOL, CURRENT_PRICE
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
WHERE CURRENT_PRICE BETWEEN 0.98 AND 1.02;

-- Checking the result
SELECT * FROM CRYPTO_DB.ANALYSIS.STABLECOINS LIMIT 5;

-- View 3: TOP_VOLATILE_COINS_24H
CREATE OR REPLACE VIEW CRYPTO_DB.ANALYSIS.TOP_VOLATILE_COINS_24H AS
SELECT NAME, SYMBOL, ROUND(ABS(PRICE_CHANGE_PERCENTAGE_24H), 2) AS VOLATILITY_SCORE
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
WHERE PRICE_CHANGE_PERCENTAGE_24H IS NOT NULL
ORDER BY VOLATILITY_SCORE DESC
LIMIT 10;

-- Checking the result
SELECT * FROM CRYPTO_DB.ANALYSIS.TOP_VOLATILE_COINS_24H LIMIT 5;

-- View 4: RECOVERY_POTENTIAL_COINS
CREATE OR REPLACE VIEW CRYPTO_DB.ANALYSIS.RECOVERY_POTENTIAL_COINS AS
SELECT NAME, SYMBOL, CURRENT_PRICE, ATH,
  ROUND(((ATH - CURRENT_PRICE) / ATH) * 100, 2) AS DROP_FROM_ATH
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
WHERE ATH > 0
  AND ((ATH - CURRENT_PRICE) / ATH) BETWEEN 0.6 AND 0.8
ORDER BY DROP_FROM_ATH DESC;

-- Checking the result
SELECT * FROM CRYPTO_DB.ANALYSIS.RECOVERY_POTENTIAL_COINS LIMIT 5;

-- View 5: RECOMMENDED_COINS_FOR_INVESTMENT
CREATE OR REPLACE VIEW CRYPTO_DB.ANALYSIS.RECOMMENDED_COINS_FOR_INVESTMENT AS
SELECT 
  NAME, 
  SYMBOL, 
  MARKET_CAP_RANK, 
  PRICE_CHANGE_PERCENTAGE_24H, 
  TOTAL_VOLUME
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
WHERE 
  MARKET_CAP_RANK > 100
  AND PRICE_CHANGE_PERCENTAGE_24H > 10
  AND TOTAL_VOLUME > 5000000
ORDER BY PRICE_CHANGE_PERCENTAGE_24H DESC
LIMIT 10;

-- Checking the result
SELECT * FROM CRYPTO_DB.ANALYSIS.RECOMMENDED_COINS_FOR_INVESTMENT LIMIT 5;

-- View 6: TOP_STABLECOINS_BY_VOLUME
CREATE OR REPLACE VIEW CRYPTO_DB.ANALYSIS.TOP_STABLECOINS_BY_VOLUME AS
SELECT NAME, SYMBOL, TOTAL_VOLUME
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
WHERE IS_STABLECOIN = TRUE
ORDER BY TOTAL_VOLUME DESC
LIMIT 10;

-- Checking the result
SELECT * FROM CRYPTO_DB.ANALYSIS.TOP_STABLECOINS_BY_VOLUME LIMIT 5;

-- View 7: MARKET_SEGMENTS_WITH_STATS
CREATE OR REPLACE VIEW CRYPTO_DB.ANALYSIS.MARKET_SEGMENTS_WITH_STATS AS
SELECT 
  CASE 
    WHEN MARKET_CAP > 1e10 THEN 'Mega Cap'
    WHEN MARKET_CAP > 1e9 THEN 'Large Cap'
    WHEN MARKET_CAP > 1e8 THEN 'Mid Cap'
    ELSE 'Small Cap'
  END AS CAP_SEGMENT,
  ROUND(AVG(CURRENT_PRICE), 2) AS AVG_PRICE,
  ROUND(AVG(TOTAL_VOLUME), 2) AS AVG_VOLUME,
  ARRAY_AGG(NAME) AS COIN_NAMES
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
GROUP BY CAP_SEGMENT;

-- Checking the result
SELECT * FROM CRYPTO_DB.ANALYSIS.MARKET_SEGMENTS_WITH_STATS LIMIT 5;

-- View 8: TOP_GAINERS_AND_LOSERS
-- Top 10 Gainers
CREATE OR REPLACE VIEW CRYPTO_DB.ANALYSIS.TOP_GAINERS AS
SELECT NAME, SYMBOL, PRICE_CHANGE_PERCENTAGE_24H
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
ORDER BY PRICE_CHANGE_PERCENTAGE_24H DESC
LIMIT 10;

-- Checking the result
SELECT * FROM CRYPTO_DB.ANALYSIS.TOP_GAINERS LIMIT 5;

-- Top 10 Losers
CREATE OR REPLACE VIEW CRYPTO_DB.ANALYSIS.TOP_LOSERS AS
SELECT NAME, SYMBOL, PRICE_CHANGE_PERCENTAGE_24H
FROM CRYPTO_DB.ANALYSIS.ALL_COINS
ORDER BY PRICE_CHANGE_PERCENTAGE_24H ASC
LIMIT 10;

-- Checking the result
SELECT * FROM CRYPTO_DB.ANALYSIS.TOP_LOSERS LIMIT 5;

-- View 9: TOP5_DOMINANCE_PERCENTAGE
CREATE OR REPLACE VIEW CRYPTO_DB.ANALYSIS.TOP5_DOMINANCE_PERCENTAGE AS
WITH top5 AS (
  SELECT SUM(MARKET_CAP) AS TOP5_CAP
  FROM CRYPTO_DB.ANALYSIS.ALL_COINS
  ORDER BY MARKET_CAP DESC
  LIMIT 5
), total AS (
  SELECT SUM(MARKET_CAP) AS TOTAL_CAP
  FROM CRYPTO_DB.ANALYSIS.ALL_COINS
)
SELECT 
  ROUND((TOP5_CAP / TOTAL_CAP) * 100, 2) AS TOP5_DOMINANCE_PERCENTAGE
FROM top5, total;

-- Checking the result
SELECT * FROM CRYPTO_DB.ANALYSIS.TOP5_DOMINANCE_PERCENTAGE;
